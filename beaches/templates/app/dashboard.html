{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nautiq | Табло</title>
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo/logo.svg' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'nav.css' %}">
    <link rel="stylesheet" href="{% static 'alert.css' %}?={{ timestamp }}">
</head>
<style>
    .dashboard-top{
        background-size: cover !important;
        background: url('{% static "images/login_img.jpg" %}') no-repeat center center;
    }
</style>
<body>
    
    {% include 'app/components/navbar.html' %}

    <div id="popup-alert-container"></div>

    {% if messages %}
        <div id="django-messages">
            {% for message in messages %}
                <div class="django-message" data-level="{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="dashboard-top">
        <div class="content">
            <h1><span class="regular">Здравей,</span> {{ user.username }}!</h1>
        </div>
    </div>

    <div class="dashboard-wrapper">
       <div class="leaderboard">
    <h2>Класация</h2>

    <!-- TOP 3 -->
    <div class="leaderboard-top">
        {% for lb in leaderboard|slice:":3" %}
        <div class="leaderboard-top-box">
            <div class="medal 
                {% if forloop.counter == 1 %}medal-gold
                {% elif forloop.counter == 2 %}medal-silver
                {% else %}medal-bronze{% endif %}">
                <i class="bi bi-trophy"></i>
            </div>

            <p>{{ lb.username }}</p>
            <span class="top-points">{{ lb.score }}</span>
        </div>
        {% endfor %}
    </div>

    <h3>Пълна класация</h3>
        <!-- FULL LEADERBOARD -->
        <div class="full-leaderboard">
                {% for lb in leaderboard %}
                <div class="leaderboard-place">
                    <div class="account-wrapper">

                        <!-- #1, #2, #3, etc. -->
                        <span class="place">{{ lb.place }}</span>

                        <!-- User picture -->
                        <img src="{{ lb.profile_img }}" alt="user-pfp" class="user-pfp">

                        <div class="user-wrapper">
                            <div class="flex-row">

                                <!-- Username -->
                                <span class="username">{{ lb.username }}</span>

                                <!-- Highlight current user -->
                                {% if lb.is_current_user %}
                                    <span class="you-tag">Вие</span>
                                {% endif %}
                            </div>

                            <!-- Monthly tasks completed -->
                            <span class="user-stats">{{ lb.tasks_completed }}</span>
                        </div>
                    </div>

                    <!-- Score formatted with k_format -->
                    <span class="score">{{ lb.score|k_format }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="stats-wrapper">
            <div class="stats-box">
                <div class="stats-top">
                    <span class="top-title">Изпълнени мисии</span>
                    <div class="icon-box">
                        <i class="bi bi-bullseye"></i>
                    </div>
                </div>
                <div class="stats-box-content">
                    <div class="stats-number">
                        {{ profile.tasks_completed }}
                    </div>
                    <span class="stats-tag-blue">
                        за целия период
                    </span>
                </div>
            </div>
            
            <div class="stats-box">
                <div class="stats-top">
                    <span class="top-title">XP точки</span>
                    <div class="icon-box">
                        <i class="bi bi-star-fill"></i>
                    </div>
                </div>
                <div class="stats-box-content">
                    <div class="stats-number">
                        {{ profile.xp }}
                    </div>
                    <span class="stats-tag-blue">
                        за целия период
                    </span>
                </div>
            </div>

            <div class="stats-box gap-24 d-flex-column">
                <div class="text-wrapper">
                    <h3>Готов ли си?</h3>
                    <p>
                        Конкурирай се с останалите<br>
                        за първо място!
                    </p>
                </div>
                <a href="{% url 'tasks' %}" class="btn-small-for-box">
                    Мисии
                </a>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const djangoMessages = document.querySelectorAll('#django-messages .django-message');
            djangoMessages.forEach(msgEl => {
                const rawTags = msgEl.dataset.level || '';
                const tags = rawTags.toLowerCase().split(/\s+/);
                const text = msgEl.textContent.trim();
                if (!text) return;

                let type = 'success';
                if (tags.includes('danger')) type = 'danger';
                else if (tags.includes('success')) type = 'success';
                else if (tags.includes('info')) type = 'success';

                showPopupAlert(text, type, 4000);
            });
        });
    </script>
    <script src="{% static 'js/closeAlert.js' %}"></script>
    <script src="{% static 'js/popupAlert.js' %}"></script>
</body>
</html>