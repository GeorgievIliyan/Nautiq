{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nautiq | Карта</title>
    <!-- MAP LIBRE -->
    <link href="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
    <script src="https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js"></script>
    <!--Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'modals.css' %}">
    <link rel="stylesheet" href="{% static 'map.css' %}?v={{ timestamp }}">
    <link rel="stylesheet" href="{% static 'alert.css' %}">
    <link rel="stylesheet" href="{% static 'nav.css' %}">
    <!--FAVICON-->
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo/logo.svg' %}">
</head>
<style>
    .modal{
        display: none;
    }
    .modal-overlay{
        display: none;
    }
    textarea {
        resize: vertical;
        overflow-y: auto;
        scrollbar-width: none;
        max-width: 100%;
        box-sizing: border-box;
    }
    textarea::-webkit-scrollbar {
        display: none;
        width: 0px;
    }

    textarea::-webkit-scrollbar-track{
        display: none;
    }

    textarea::-webkit-scrollbar-button{
        display: none;
    }
</style>
<body>
    {% include 'app/modals/mapModals.html' %}

    {% include 'app/components/navbar.html' %}

    <div id="popup-alert-container"></div>

    {% if messages %}
        <div id="django-messages">
            {% for message in messages %}
                <div class="django-message" data-level="{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div id="map"></div>

    <div id="info-panel" class="info-panel" aria-hidden="true">
        <button id="close-panel" type="button" aria-label="Close panel"><i class="bi bi-x"></i></button>
        <div id="info-content"></div>
    </div>

    <div id="info-bottom" class="info-bottom" aria-hidden="true">
        <div id="drag-handle" role="button" aria-label="Close bottom sheet"></div>
        <div id="info-bottom-content"></div>
    </div>

    <span id="user_lat" class="d-none">{{ user_lat }}</span>
    <span id="user_lng" class="d-none">{{ user_lng }}</span>
    {{ beaches|json_script:"beaches_json" }}

    <script src="{% static 'js/mapModals.js' %}"></script>
    <script src="{% static 'js/popupAlert.js' %}"></script>

    <!--MAPLIBRE-->
    <script>
        const infoPanel = document.getElementById("info-panel");
        const infoContent = document.getElementById("info-content");
        const bottomSheet = document.getElementById("info-bottom");
        const bottomContent = document.getElementById("info-bottom-content");
        const closePanelBtn = document.getElementById("close-panel");

        const latInput = document.getElementById("id_latitude");
        const lngInput = document.getElementById("id_longitude");

        const USER_LAT = (document.getElementById('user_lat') && document.getElementById('user_lat').textContent.trim()) 
            ? parseFloat(document.getElementById('user_lat').textContent) 
            : 43.204666;
        const USER_LNG = (document.getElementById('user_lng') && document.getElementById('user_lng').textContent.trim()) 
            ? parseFloat(document.getElementById('user_lng').textContent) 
            : 27.910543;

        let REAL_USER_LAT, REAL_USER_LNG;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    REAL_USER_LAT = pos.coords.latitude;
                    REAL_USER_LNG = pos.coords.longitude;
                    console.log("Real user location:", REAL_USER_LAT, REAL_USER_LNG);
                    centerMapOnUser();
                    addUserLocationMarker();
                },
                err => {
                    console.warn("Неуспешно получаване на текуща локация! Използва се fallback.", err);
                    map.setCenter([USER_LNG, USER_LAT]);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            map.setCenter([USER_LNG, USER_LAT]);
        }

        function centerMapOnUser() {
            if (REAL_USER_LAT !== undefined && REAL_USER_LNG !== undefined) {
                map.setCenter([REAL_USER_LNG, REAL_USER_LAT]);
            } else {
                map.setCenter([USER_LNG, USER_LAT]);
            }
        }

        function addUserLocationMarker() {
            if (REAL_USER_LAT === undefined || REAL_USER_LNG === undefined) return;

            const el = document.createElement('div');
            el.className = 'user-location-marker';
            el.style.backgroundColor = '#28a745';
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.borderRadius = '50%';
            el.style.border = '2px solid white';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';
            el.style.color = 'white';
            el.style.fontSize = '10px';
            el.innerText = 'Вие';

            new maplibregl.Marker(el)
                .setLngLat([REAL_USER_LNG, REAL_USER_LAT])
                .addTo(map);
        }

        let BEACHES_DATA = [];
        const beachesScript = document.getElementById('beaches_json');
        if (beachesScript) {
            try { BEACHES_DATA = JSON.parse(beachesScript.textContent); } 
            catch (err) { console.error('Failed to parse beaches_json:', err); BEACHES_DATA = []; }
        }

        const MIN_DISTANCE_METERS = 250;
        const MIN_MARKER_ZOOM = 10;
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        let mapTheme = prefersDark ? "jawg-dark" : "jawg-lagoon";

        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.jawg.io/styles/${mapTheme}.json?access-token={{ jawg_token }}`,
            zoom: 12,
            center: [USER_LNG, USER_LAT]
        });
        map.addControl(new maplibregl.NavigationControl());

        let newMarker = null;
        const existingMarkers = [];
        const beachMarkers = [];

        const keyTranslations = {
            has_lifeguard:"Спасител", has_parking:"Паркинг", has_paid_parking:"Платен паркинг",
            has_paid_zone:"Платена зона", has_beach_bar:"Бийч бар", has_toilets:"Тоалетни",
            has_changing_rooms:"Съблекални", times_logged:"Брой отчети", crowd_avr:"Натовареност",
            clarity_avr:"Видимост на водата", water_temp_avr:"Температура на водата", weather_avr:"Време",
            algae_avr:"Водорасли", kids_avr:"Деца", waves:"Вълни", parking_space:"Паркинг място"
        };

        const valueTranslations = {
            high:"Големи", medium:"Средни", small:"Малки", none:"Няма",
            hot:"Гореща", warm:"Топла", normal:"Нормална", cool:"Хладка", cold:"Студена",
            low:"Ниско", cloudy:"Облачна", murky:"Мътна", clear:"Ясна"
        };

        function deg2rad(deg){ return deg*(Math.PI/180); }
        function getDistanceMeters(lat1, lon1, lat2, lon2){
            const R=6371;
            const dLat=deg2rad(lat2-lat1);
            const dLon=deg2rad(lon2-lon1);
            const a=Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
            const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
            return R*c*1000;
        }

        function safeAddClass(el,cls){ if(el) el.classList.add(cls); }
        function safeRemoveClass(el,cls){ if(el) el.classList.remove(cls); }

        function updateMarkerVisibility(){
            const zoom=map.getZoom();
            beachMarkers.forEach(marker=>{
                const el=marker&&marker.getElement();
                if(!el) return;
                el.style.display = zoom>=MIN_MARKER_ZOOM?"block":"none";
            });
        }

        function checkUserDistanceToBeach(lat,lng){
            if(REAL_USER_LAT===undefined || REAL_USER_LNG===undefined){
                showPopupAlert("Не може да се определи вашата локация.","danger",4000);
                return false;
            }
            const dist=getDistanceMeters(REAL_USER_LAT,REAL_USER_LNG,lat,lng);
            if(dist>300){
                showPopupAlert(`Трябва да сте в радиус от 300м до плажа! Вашата дистанция: ${Math.round(dist)} м.`, "danger",8000);
                return false;
            }
            return true;
        }

        function renderInfo(data, lat, lng){
            const target=window.innerWidth>=768?infoContent:bottomContent;
            if(!target) return;

            let html=`<img src="${data.beach_image}" class="beach-image">
                <div class="info-panel-top">
                    <h2>${data.name||"Без име"}</h2>
                    <p><i class="bi bi-star-fill"></i> ${data.rating}</p>
                    <p class="secondary">${data.lat_lng}</p>
                </div>
                <p class="beach-desc">${data.description||"Няма информация."}</p>
                <hr/><ul class="map-list">`;

            const skipKeys=["name","description","pk","log_id","id","wind","wind_direction","wind_direction_icon","wind_direction_text","weather","weather_icon","weather_desc","beach_image","degrees","lat_lng","rating","latitude","longitude","lat","lng"];

            for(const [key,value] of Object.entries(data)){
                if(skipKeys.includes(key)||value===null||value===""||typeof value==="undefined") continue;
                let displayValue = typeof value==="boolean"? (value?'<i class="bi bi-check2 confirmation-icon"></i>':'<i class="bi bi-x confirmation-icon"></i>') : (valueTranslations[value]||value);
                const normalizedKey = key.toLowerCase().replace(/\s+/g,'_');
                const translatedKey = keyTranslations[normalizedKey]||key.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
                html+=`<li><strong>${translatedKey}:</strong> ${displayValue}</li>`;
            }
            html+=`</ul>
                <div class="weather-wind">
                    <span><i class="${data.wind_direction_icon}"></i> ${data.wind_direction_text||""} ${data.wind||""} km/h</span>
                    <span><i class="${data.weather_icon} weather-icon"></i> ${data.degrees||""}°C ${data.weather_desc||""}</span>
                </div>
                <button class="btn-red mt-3" onclick="openReportModal()">Докладвайте проблем <i class="bi bi-exclamation-octagon"></i></button>
                <button class="btn-primary" onclick="openLogsModal(${data.id})">Подай отчет</button>
                ${!isNaN(lat)&&!isNaN(lng)?`<button class="btn-primary" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${lat},${lng}','_blank')">Опътвания <i class="bi bi-compass"></i></button>`:""}`;

            target.innerHTML=html;
        }

        function openInfo(data, lat, lng){
            renderInfo(data, lat, lng);
            if(window.innerWidth>=768) safeAddClass(infoPanel,"visible");
            else { bottomSheet.style.transform='translateY(0)'; safeAddClass(bottomSheet,"visible"); }
        }

        function closeInfo(){
            safeRemoveClass(infoPanel,"visible");
            if(bottomSheet){ bottomSheet.style.transform='translateY(100vh)'; bottomSheet.style.transition='transform 0.3s ease-in';
                setTimeout(()=>{ safeRemoveClass(bottomSheet,"visible"); bottomSheet.style.transition=''; },300); }
        }

        if(closePanelBtn) closePanelBtn.addEventListener("click",closeInfo);
        function isOutsideBulgaria(lat,lng){ return lat<41.2||lat>44.2||lng<22.4||lng>28.6; }

        map.on('load',()=>{
            if(!Array.isArray(BEACHES_DATA)) BEACHES_DATA=[];
            BEACHES_DATA.forEach(beach=>{
                const lat=parseFloat(beach.latitude??beach.lat);
                const lng=parseFloat(beach.longitude??beach.lng);
                if(Number.isNaN(lat)||Number.isNaN(lng)) return;

                const coords=[lng,lat];
                const marker=new maplibregl.Marker({color:"#FF7F50"}).setLngLat(coords).addTo(map);
                existingMarkers.push({marker,coordinates:coords,id:beach.id});
                beachMarkers.push(marker);

                marker.getElement().addEventListener("click",async ev=>{
                    ev.stopPropagation();
                    try{
                        const resp=await fetch(`/beach/${beach.id}/`);
                        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data=await resp.json();
                        if(latInput) latInput.value=data.latitude??lat;
                        if(lngInput) lngInput.value=data.longitude??lng;
                        const beachInput=document.getElementById("id_beach");
                        if(beachInput) beachInput.value=beach.id;
                        openInfo(data,lat,lng);
                    }catch(err){
                        console.error("Error fetching beach data:",err);
                        if(infoContent) infoContent.innerHTML=`<p class="text-danger">Възникна грешка при зареждането на информацията.</p>`;
                        safeAddClass(infoPanel,"visible");
                    }
                });
            });
            updateMarkerVisibility();
            map.on('zoom',updateMarkerVisibility);
        });

        map.on('click',e=>{
            const {lng,lat}=e.lngLat;
            if(isOutsideBulgaria(lat,lng)){ showPopupAlert("Вие сте извън границите на България!"); return; }

            closeInfo();

            for(const m of existingMarkers){
                const [mlng,mlat]=m.coordinates;
                if(getDistanceMeters(lat,lng,mlat,mlng)<MIN_DISTANCE_METERS){
                    showPopupAlert("Твърде близо до съществуващ плаж!","danger",4000);
                    return;
                }
            }

            if(newMarker) newMarker.remove();
            newMarker=new maplibregl.Marker({color:"#0077ff"}).setLngLat([lng,lat]).addTo(map);
            if(latInput) latInput.value=lat.toFixed(6);
            if(lngInput) lngInput.value=lng.toFixed(6);

            const popupContent=document.createElement('div');
            popupContent.className='popup-marker-content';
            popupContent.innerHTML=`
                <p class="fw-semibold">Нов плаж</p>
                <p class="secondary">${lat.toFixed(5)}, ${lng.toFixed(5)}</p>
                <button class="btn-primary-xs">Добави плаж</button>
            `;
            const btn=popupContent.querySelector('button');
            if(btn) btn.addEventListener('click',evt=>{
                evt.preventDefault();
                if(checkUserDistanceToBeach(lat,lng) && typeof openAddModal==="function") openAddModal();
            });

            newMarker.setPopup(new maplibregl.Popup().setDOMContent(popupContent)).togglePopup();
            beachMarkers.push(newMarker);
            updateMarkerVisibility();
        });

        if(window.matchMedia){
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{
                const newTheme=e.matches?'jawg-dark':'jawg-lagoon';
                map.setStyle(`https://api.jawg.io/styles/${newTheme}.json?access-token={{ jawg_token }}`);
            });
        }
    </script>
    <!--MENU-->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('nav ul li').forEach(item => {
                item.classList.remove('active');
            });
            const map_nav_element = document.getElementById("nav-map");
            if (map_nav_element) {
                map_nav_element.classList.add("active");
                const indicator = document.querySelector('.nav-indicator');
                if (indicator && window.matchMedia('(min-width:601px)').matches) {
                    const rect = map_nav_element.getBoundingClientRect();
                    const navRect = map_nav_element.closest('nav').getBoundingClientRect();
                    indicator.style.left = (rect.left - navRect.left) + 'px';
                    indicator.style.top = (rect.top - navRect.top) + 'px';
                    indicator.style.width = rect.width + 'px';
                    indicator.style.height = rect.height + 'px';
                    indicator.style.display = 'block';
                }
            }
        });
    </script>
    <!--ALERTS-->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const djangoMessages = document.querySelectorAll('#django-messages .django-message');
            djangoMessages.forEach(msgEl => {
                const rawTags = msgEl.dataset.level || '';
                const tags = rawTags.toLowerCase().split(/\s+/);
                const text = msgEl.textContent.trim();
                if (!text) return;

                let type = 'success';
                if (tags.includes('danger')) type = 'danger';
                else if (tags.includes('success')) type = 'success';
                else if (tags.includes('info')) type = 'success';
                showPopupAlert(text, type, 4000);
            });
        });
    </script>
</body>
</html>