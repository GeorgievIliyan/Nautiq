{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaSight | Map</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <!--Bootstrap Icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'styles.css' %}">

    <!--Favicon-->
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo/logo.png' %}">
</head>

<style>
    html, body {
        height: 100%;
        margin: 0;
    }
    body {
        display: flex;
        flex-direction: row;
        overflow: hidden;
    }
    #map {
        flex-grow: 1;
        height: 100vh;
    }
    .map-toggle-btn {
        position: fixed;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        z-index: 2000;
        border-radius: 0 4px 4px 0;
    }
    .offcanvas-start {
        width: 300px;
        z-index: 1500;
    }

    #right-sidebar {
        width: 300px;
        height: 100vh;
        overflow-y: auto;
        padding: 2rem;
        border-left: 1px solid #dee2e6;
    }
</style>

<body>
    <button class="btn btn-primary rounded-circle shadow position-fixed top-50 start-0 translate-middle-y d-flex align-items-center justify-content-center" 
            style="width:45px; height:45px; margin-left:5px; z-index:1050;" 
            type="button" data-bs-toggle="offcanvas" data-bs-target="#sideMenu" aria-controls="sideMenu">
        <span class="fs-5 text-white">&raquo;</span>
    </button>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="sideMenu">
        <div class="offcanvas-header border-0 bg-primary text-white rounded-end">
            <h4 class="fw-bold m-0">SeaSight</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body p-0 bg-light d-flex flex-column vh-100 shadow">
            <div class="nav flex-column mt-3">
                <a href="{% url 'dashboard' %}" class="nav-link d-flex align-items-center text-primary fw-bold py-3 px-4 rounded bg-primary bg-opacity-10 mb-1">
                    <i class="bi bi-person me-2"></i> Табло
                </a>
                <a href="{% url 'account' %}" class="nav-link d-flex align-items-center text-dark py-3 px-4 rounded mb-1 hover-bg-primary">
                    <i class="bi bi-map me-2"></i> Акаунт
                </a>
                <a href="{% url 'my_logs' %}" class="nav-link d-flex align-items-center text-dark py-3 px-4 rounded mb-1 hover-bg-primary">
                    <i class="bi bi-journal-text me-2"></i>Моя принос
                </a>
            </div>

            <div class="mt-auto p-3">
                <a href="#" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center">
                    <i class="bi bi-box-arrow-right me-2"></i> Излез
                </a>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div id="map" data-beach-add-url="{% url 'beach_add' %}"></div>

    <!-- Right Sidebar -->
    <div class="col-lg-4 col-12 border-start d-flex flex-column h-100 p-4 bg-light shadow-sm">
        <!-- Sidebar Header -->
        <div class="mb-4 d-flex align-items-center justify-content-between">
            <h2 class="fw-bold text-primary m-0">SeaSight</h2>
        </div>

        <!-- Messages at the top -->
        {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-3 shadow-sm" role="alert">
                <i class="bi bi-info-circle me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Sidebar Content -->
        <div class="flex-grow-1 overflow-auto">
            <h3 class="fs-6 fw-semibold text-secondary d-flex align-items-center mb-3">
                <i class="bi bi-geo-alt-fill me-2 text-primary"></i> Информация за плажове
            </h3>
            <p class="text-muted small mb-3">Натиснете върху плаж, за да разгледате детайли</p>

            <!-- Beach List -->
            <div class="list-group list-group-flush">
                {% for beach in beaches %}
                <a href="#" class="list-group-item list-group-item-action d-flex flex-column rounded mb-3 shadow-sm p-3 bg-white">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-sun-fill me-2 text-warning fs-5"></i>
                        <span class="fw-bold">{{ beach.name }}</span>
                    </div>
                    <p class="text-muted small mb-2">{{ beach.description }}</p>

                    <!-- Beach Features -->
                    <div class="d-flex flex-wrap gap-2">
                        {% if beach.has_lifeguard %}
                            <span class="badge bg-primary"><i class="bi bi-shield-fill-check me-1"></i>Lifeguard</span>
                        {% endif %}
                        {% if beach.has_parking %}
                            <span class="badge bg-secondary"><i class="bi bi-car-front-fill me-1"></i>Parking</span>
                        {% endif %}
                        {% if beach.has_paid_parking %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-cash-stack me-1"></i>Paid Parking</span>
                        {% endif %}
                        {% if beach.has_toilets %}
                            <span class="badge bg-info text-dark"><i class="bi bi-droplet me-1"></i>Toilets</span>
                        {% endif %}
                        {% if beach.has_changing_rooms %}
                            <span class="badge bg-success"><i class="bi bi-person-lines-fill me-1"></i>Changing Rooms</span>
                        {% endif %}
                        {% if beach.has_paid_zone %}
                            <span class="badge bg-danger"><i class="bi bi-currency-dollar me-1"></i>Paid Zone</span>
                        {% endif %}
                        {% if beach.has_beach_bar %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-cup-straw me-1"></i>Beach Bar</span>
                        {% endif %}
                    </div>
                </a>
                {% empty %}
                <p class="text-muted small">Няма информация</p>
                {% endfor %}
            </div>
        </div>
    </div>


    <span id="user_lat" class="d-none">{{ user_lat }}</span>
    <span id="user_lng" class="d-none">{{ user_lng }}</span>
    {{ beaches|json_script:"beaches_json"}}

    </div>

    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- LEAFLET & EXISTING JS (UNCHANGED) -->
    <script>
        const lat = parseFloat(document.getElementById('user_lat').textContent);
        const lng = parseFloat(document.getElementById('user_lng').textContent);

        window.onload = function() {
            var map = L.map('map').setView([lat, lng], 14);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            let beaches = JSON.parse(document.getElementById('beaches_json').textContent);
            let userMarker = null;

            const displayValue = val => val === null ? "Няма информация" : val;

            map.on('click', (e) => {
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

                userMarker.bindPopup(`
                    <div class="p-2">
                        <p class="fs-5 fw-semibold text-primary mb-2 mt-0">Маркер</p>
                        <p class="mb-2">
                            Координати: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}
                        </p>
                        <a href="{% url 'beach_add' %}?lat=${e.latlng.lat}&lng=${e.latlng.lng}" class="link-primary link-underline-primary">
                            Добави като плаж <i class="bi bi-plus-circle"></i>
                        </a>
                    </div>
                `).openPopup();

            });

            beaches.forEach(beach => {
                const marker = L.marker([beach.latitude, beach.longitude], { markerId: beach.id }).addTo(map);

                marker.on('click', function() {
                    fetch(`/beach/${this.options.markerId}/`)
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            this.bindPopup(`<b>${displayValue(data.name)}</b>`).openPopup();

                            const sidebar = document.getElementById("sidebar");
                            if (!sidebar) return;

                            sidebar.innerHTML = `
                                <h2>${displayValue(data.name)}</h2>
                                <p>${displayValue(data.description)}</p>
                                <p>Доклади днес: ${displayValue(data.times_logged)}</p>
                                <p>Платена зона: ${displayValue(data.has_paid_zone)}</p>
                                <p>Паркинг: ${displayValue(data.has_parking)}</p>
                                <p>Платен паркинг: ${displayValue(data.has_paid_parking)}</p>
                                <p>Заведения: ${displayValue(data.has_beach_bar)}</p>
                                <p>Съблекални: ${displayValue(data.has_changing_rooms)}</p>
                                <p>Тоалетни: ${displayValue(data.has_toilets)}</p>

                                <a id="report-link" class="btn btn-danger mt-3" data-url-base="{% url 'report_beach' '00000000-0000-0000-0000-000000000000' %}">Докладвайте проблем с този плаж</a>

                                <h3 class="mt-5">Условията днес: </h3>
                                <p>Честота на водата: ${displayValue(data.clarity_avr)}</p>
                                <p>Количество хора: ${displayValue(data.crowd_avr)}</p>
                                <p>Време: ${displayValue(data.weather_avr)}</p>
                                <p>Усещане на водата: ${displayValue(data.water_temp_avr)}</p>
                                <p>Водорасли: ${displayValue(data.algae_avr)}</p>
                                <p>Количество деца: ${displayValue(data.kids_avr)}</p>
                                <p>Вълни: ${displayValue(data.waves)}</p>
                                <p>Място за паркиране: ${displayValue(data.parking_space)}</p>

                                <a id="log-link" class="btn btn-primary" data-url-base="{% url 'log_beach' '00000000-0000-0000-0000-000000000000' %}">Докладвайте данни за този плаж</a>
                                <a id="spec-log-link"
                                    class="btn btn-success mt-3"
                                    href="#"
                                    data-url-base="{% url 'log_beach_spec' '00000000-0000-0000-0000-000000000000' %}">
                                        Доклади за днес
                                </a>
                            `;

                            const logLink = document.getElementById('log-link');
                            if (logLink) logLink.href = logLink.dataset.urlBase.replace('00000000-0000-0000-0000-000000000000', data.pk);

                            const reportLink = document.getElementById('report-link');
                            if (reportLink) reportLink.href = reportLink.dataset.urlBase.replace('00000000-0000-0000-0000-000000000000', data.pk);

                            const specLogLink = document.getElementById('spec-log-link');
                            if (specLogLink) specLogLink.href = specLogLink.dataset.urlBase.replace(
                                '00000000-0000-0000-0000-000000000000',
                                data.pk
                            );
                        })
                        .catch(error => {
                            console.error('Fetch error:', error);
                            this.bindPopup('Възникна грешка!').openPopup();
                        });
                });
            });
        }
    </script>

</body>
</html>