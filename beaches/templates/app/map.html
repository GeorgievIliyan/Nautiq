{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaSight | Map</title>

    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <!-- CUSTOM FONT & STYLES -->
    <style>
        @import url('https://fonts.googleapis.com/css?family=Onest:100,200,300,regular,500,600,700,800,900');
        * { font-family: "Onest", sans-serif; margin:0; padding:0; }
        html, body { height: 100%; }
        #map { width: 100%; height: 100%; }
        #sidebar { height: 100%; overflow-y: auto; background-color: #fff; }
        .container-fluid { height: 100%; padding: 0; }
    </style>
</head>
<body>
    <div class="container-fluid d-flex flex-column vh-100">

        <!-- Map + Sidebar -->
        <div class="row g-0 flex-grow-1">

            <!-- Map (80%) -->
            <div class="col-lg-8 col-12 h-100">
                <div id="map" data-beach-add-url="{% url 'beach_add' %}"></div>
            </div>

            <!-- Sidebar (20%) -->
            <div class="col-lg-4 col-12 border-start d-flex flex-column h-100 p-5">
                <h2 class="fw-semibold mb-5">SeaSight</h2>
                <div id="sidebar" class="d-flex flex-column h-100">
                    <!-- Messages at the top of sidebar -->
                    {% if messages %}
                        <div class="mb-3">
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                        
                    {% endif %}

                    <!-- Sidebar content -->
                    <div class="flex-grow-1 overflow-auto">
                        <h2 class="fs-5 fw-semibold">Информация за плажове</h2>
                        <p class="text-muted">Натиснете върху плаж, за да разгледате детайли</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden user coordinates -->
        <span id="user_lat" class="d-none">{{ user_lat }}</span>
        <span id="user_lng" class="d-none">{{ user_lng }}</span>
        {{ beaches|json_script:"beaches_json"}}

    </div>

    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- LEAFLET & EXISTING JS (UNCHANGED) -->
    <script>
        const lat = parseFloat(document.getElementById('user_lat').textContent);
        const lng = parseFloat(document.getElementById('user_lng').textContent);

        window.onload = function() {
            var map = L.map('map').setView([lat, lng], 14);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            let beaches = JSON.parse(document.getElementById('beaches_json').textContent);
            let userMarker = null;

            const displayValue = val => val === null ? "Няма информация" : val;

            map.on('click', (e) => {
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

                userMarker.bindPopup(`
                    <b>Маркер</b><br>
                    Latitude: ${e.latlng.lat.toFixed(5)}<br>
                    Longitude: ${e.latlng.lng.toFixed(5)}<br>
                    <a href="{% url 'beach_add' %}?lat=${e.latlng.lat}&lng=${e.latlng.lng}">
                        Добавете това място като плаж
                    </a>
                `).openPopup();
            });

            beaches.forEach(beach => {
                const marker = L.marker([beach.latitude, beach.longitude], { markerId: beach.id }).addTo(map);

                marker.on('click', function() {
                    fetch(`/beach/${this.options.markerId}/`)
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            this.bindPopup(`<b>${displayValue(data.name)}</b>`).openPopup();

                            const sidebar = document.getElementById("sidebar");
                            if (!sidebar) return;

                            sidebar.innerHTML = `
                                <h2>${displayValue(data.name)}</h2>
                                <p>${displayValue(data.description)}</p>
                                <p>Доклади днес: ${displayValue(data.times_logged)}</p>
                                <p>Платена зона: ${displayValue(data.has_paid_zone)}</p>
                                <p>Паркинг: ${displayValue(data.has_parking)}</p>
                                <p>Платен паркинг: ${displayValue(data.has_paid_parking)}</p>
                                <p>Заведения: ${displayValue(data.has_beach_bar)}</p>
                                <p>Съблекални: ${displayValue(data.has_changing_rooms)}</p>
                                <p>Тоалетни: ${displayValue(data.has_toilets)}</p>

                                <a id="report-link" class="btn btn-danger mt-3" data-url-base="{% url 'report_beach' '00000000-0000-0000-0000-000000000000' %}">Докладвайте проблем с този плаж</a>

                                <h3 class="mt-5">Условията днес: </h3>
                                <p>Честота на водата: ${displayValue(data.clarity_avr)}</p>
                                <p>Количество хора: ${displayValue(data.crowd_avr)}</p>
                                <p>Време: ${displayValue(data.weather_avr)}</p>
                                <p>Усещане на водата: ${displayValue(data.water_temp_avr)}</p>
                                <p>Водорасли: ${displayValue(data.algae_avr)}</p>
                                <p>Количество деца: ${displayValue(data.kids_avr)}</p>
                                <p>Вълни: ${displayValue(data.waves)}</p>
                                <p>Място за паркиране: ${displayValue(data.parking_space)}</p>

                                <a id="log-link" class="btn btn-primary" data-url-base="{% url 'log_beach' '00000000-0000-0000-0000-000000000000' %}">Докладвайте данни за този плаж</a>
                                <a id="spec-log-link"
                                    class="btn btn-success mt-3"
                                    href="#"
                                    data-url-base="{% url 'log_beach_spec' '00000000-0000-0000-0000-000000000000' %}">
                                        Доклади за днес
                                </a>
                            `;

                            const logLink = document.getElementById('log-link');
                            if (logLink) logLink.href = logLink.dataset.urlBase.replace('00000000-0000-0000-0000-000000000000', data.pk);

                            const reportLink = document.getElementById('report-link');
                            if (reportLink) reportLink.href = reportLink.dataset.urlBase.replace('00000000-0000-0000-0000-000000000000', data.pk);

                            const specLogLink = document.getElementById('spec-log-link');
                            if (specLogLink) specLogLink.href = specLogLink.dataset.urlBase.replace(
                                '00000000-0000-0000-0000-000000000000',
                                data.pk
                            );
                        })
                        .catch(error => {
                            console.error('Fetch error:', error);
                            this.bindPopup('Възникна грешка!').openPopup();
                        });
                });
            });
        }
    </script>

</body>
</html>