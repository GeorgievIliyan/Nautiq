{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nautiq | Мисии</title>
    <!--CSS-->
    <link rel="stylesheet" href="{% static 'alert.css' %}">
    <link rel="stylesheet" href="{% static 'nav.css' %}">
    <link rel="stylesheet" href="{% static 'tasks.css' %}">
    <!--Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>
<body>
    {% include 'app/components/navbar.html' %}

    <div id="popup-alert-container"></div>
    
    <div id="django-messages" style="display:none;"> 
        {% if messages %}
            {% for message in messages %}
                <div class="django-message" data-level="{{ message.level_tag }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    {% for task in tasks %} <div>
            <h2>{{ task.title }}</h2>
            <p>{{ task.user_desc }}</p>
            <p>{{ task.reward }} XP</p>
            
            {% if task.id in completed_ids %}
                <p class="text-green"><i class="bi bi-check-lg"></i> Изпълнено</p>
            
            {% elif task.id in accepted_ids %}
                <form action="{% url 'complete_task' task.id %}" method="POST" enctype="multipart/form-data" class="mt-3">
                    {% csrf_token %}
                    <label class="text-sm font-medium">Upload proof:</label>
                    <input type="file" name="proof_image" accept="image/*" required class="block mt-1">
                    <button class="bg-blue-500 text-white px-4 py-2 mt-2 rounded-md">Submit Proof</button>
                </form>

            {% else %}
                <form action="{% url 'accept_task' task.id %}" method="POST" class="mt-3">
                    {% csrf_token %}
                    <button class="bg-green-500 text-white px-4 py-2 rounded-md">Accept Task</button>
                </form>
            {% endif %}
            
        </div>
    {% empty %}
        <p>Нямате мисии...</p>
    {% endfor %}

    <script src="{% static 'js/navBar.js' %}"></script>
    <script src="{% static 'js/closeAlert.js' %}"></script>
    <script src="{% static 'js/popupAlert.js' %}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messageElements = document.querySelectorAll('#django-messages .django-message');
            messageElements.forEach(el => {
                const text = el.textContent.trim();
                let level = el.dataset.level || 'danger';
                
                // Ensure proper mapping to your custom alert function's levels
                if (level.includes('success')) level = 'success';
                else if (level.includes('error') || level.includes('danger')) level = 'danger';
                else if (level.includes('warning')) level = 'warning';
                else if (level.includes('info')) level = 'info';
                else level = 'danger'; // Default fallback

                // Assuming showPopupAlert is defined in popupAlert.js
                showPopupAlert(text, level, 4000);
            });
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('nav ul li').forEach(item => {
                item.classList.remove('active');
            });
            const mis_nav_element = document.getElementById("nav-missions");
            if (mis_nav_element) {
                mis_nav_element.classList.add("active");
                const indicator = document.querySelector('.nav-indicator');
                if (indicator && window.matchMedia('(min-width:601px)').matches) {
                    const rect = mis_nav_element.getBoundingClientRect();
                    const navRect = mis_nav_element.closest('nav').getBoundingClientRect();
                    indicator.style.left = (rect.left - navRect.left) + 'px';
                    indicator.style.top = (rect.top - navRect.top) + 'px';
                    indicator.style.width = rect.width + 'px';
                    indicator.style.height = rect.height + 'px';
                    indicator.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>