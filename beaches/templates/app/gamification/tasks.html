{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nautiq | Мисии</title>
    <!--Favicon-->
    <link rel="icon" type="image/x-icon" href="{% static 'images/logo/logo.svg' %}">
    <!--CSS-->
    <link rel="stylesheet" href="{% static 'alert.css' %}">
    <link rel="stylesheet" href="{% static 'nav.css' %}">
    <link rel="stylesheet" href="{% static 'tasks.css' %}?v={{ timestamp }}">
    <!--Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>
<body>
    {% include 'app/components/navbar.html' %}

    <div id="popup-alert-container"></div>

    <div id="django-messages" style="display: none !important;">
        {% if messages %}
            {% for message in messages %}
                <div class="django-message" data-level="{{ message.tags }}" style="display: none !important;">{{ message }}</div>
            {% endfor %}
        {% endif %}
    </div>
    
    <h1>Готов ли си?</h1>
    <p class="xp-next">Само {{ xp_next }}XP до следващото ниво!</p>

    <div class="task-wrapper">
        {% for task in tasks %}
            <div class="task {% if task.id in completed_ids %} completed {% endif %}">
                <h2 class="task-title">{{ task.title }}</h2>
                <p class="task-desc">{{ task.user_desc }}</p>
                <p class="task-reward"><i class="bi bi-star-fill"></i> {{ task.reward }} XP</p>
                
                {% if task.id in completed_ids %}
                    <p class="text-green"><i class="bi bi-check-lg"></i> Изпълнено</p>
                {% elif task.id in accepted_ids %}
                    <form action="{% url 'complete_task' task.id %}" method="POST" enctype="multipart/form-data" class="mt-3">
                        {% csrf_token %}
                        <div></div>
                        <label class="text-sm font-medium">Снимка:</label>
                        <input type="file" name="proof_image" accept="image/*" required class="block mt-1">
                        <button class="btn-primary">Подай <i class="bi bi-arrow-right"></i></button>
                    </form>
                {% else %}
                    <form action="{% url 'accept_task' task.id %}" method="POST" class="mt-3">
                        {% csrf_token %}
                        <button class="btn-primary">Приеми</button>
                    </form>
                {% endif %}
            </div>
        {% empty %}
            <p>Нямате мисии...</p>
        {% endfor %}
    </div>

    <script src="{% static 'js/navBar.js' %}"></script>
    <script src="{% static 'js/closeAlert.js' %}"></script>
    <script src="{% static 'js/popupAlert.js' %}"></script>

    <!-- Django messages popup -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messageElements = document.querySelectorAll('#django-messages .django-message');
            messageElements.forEach(el => {
                const text = el.textContent.trim();
                let level = el.dataset.level || 'danger';
                
                if (level.includes('success')) level = 'success';
                else if (level.includes('error') || level.includes('danger')) level = 'danger';
                else if (level.includes('warning')) level = 'warning';
                else if (level.includes('info')) level = 'info';
                else level = 'danger';

                showPopupAlert(text, level, 4000);
            });
        });
    </script>

    <!-- Navbar active indicator -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('nav ul li').forEach(item => item.classList.remove('active'));
            const mis_nav_element = document.getElementById("nav-missions");
            if (mis_nav_element) {
                mis_nav_element.classList.add("active");
                const indicator = document.querySelector('.nav-indicator');
                if (indicator && window.matchMedia('(min-width:601px)').matches) {
                    const rect = mis_nav_element.getBoundingClientRect();
                    const navRect = mis_nav_element.closest('nav').getBoundingClientRect();
                    indicator.style.left = (rect.left - navRect.left) + 'px';
                    indicator.style.top = (rect.top - navRect.top) + 'px';
                    indicator.style.width = rect.width + 'px';
                    indicator.style.height = rect.height + 'px';
                    indicator.style.display = 'block';
                }
            }
        });
    </script>

</body>
</html>